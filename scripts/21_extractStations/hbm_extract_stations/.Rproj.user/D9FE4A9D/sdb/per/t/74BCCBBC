{
    "collab_server" : "",
    "contents" : "createL2file = function(stations, varnames, varlist, varmapping, dataL2, outdir, grids, suffix = '') {\n  \n  ncIdOut = list()\n  \n  copyAtts = c('cell_methods', 'positive', 'negative', 'standard_name')\n  \n  for (iStat in names(stations)) {\n    iG = stations[[iStat]]$grid\n    \n    all_dims = list()\n    all_vars = list()\n    \n    for (iD in c('lon', 'lat')) {\n      all_dims[[iD]] = ncdim_def(iD, grids[[iG]][[iD]]$units, \n                                 vals = stations[[iStat]][[iD]], \n                                 unlim = grids[[iG]][[iD]]$unlim,\n                                 longname = grids[[iG]][[iD]]$long_name)\n    }\n    \n    for (iD in c('z', 'sur', 'sed', 'time')) {\n      all_dims[[iD]] = ncdim_def(iD, grids[[iG]][[iD]]$units, \n                                 vals = grids[[iG]][[iD]]$values, \n                                 unlim = grids[[iG]][[iD]]$unlim,\n                                 longname = grids[[iG]][[iD]]$long_name)\n    }\n    all_dims$z$vals = rowMeans(dataL2[['depth']]$data[[iStat]], dim = 3)\n    \n    \n    for (iV in varnames$L2) {\n      if (iV != 'secchi') {\n        tmp_dims = list(all_dims$lon, all_dims$lat, all_dims$z, all_dims$time)\n      } else if (3 == 3) {\n        if (TRUE) {\n          tmp_dims = list(all_dims$lon, all_dims$lat, all_dims$sed, all_dims$time)\n        } else {\n          tmp_dims = list(all_dims$lon, all_dims$lat, all_dims$sur, all_dims$time)\n        }\n      } else {\n        stop(paste0('Bad dimensions of variable ', iV))\n      }\n      \n      all_vars[[iV]] = ncvar_def(varmapping$L2L2[[iV]], units = varlist[[iV]]$units,\n                           dim = tmp_dims, longname = iV, # varlist[[iV]]$longname, \n                           prec = 'float')\n    }\n    # time independent depth (averaged)\n    all_vars[['depth2']] = ncvar_def('depth2', units = 'm',\n                                     dim = list(all_dims$lon, all_dims$lat, all_dims$z), \n                                     longname = 'depth2',\n                                     prec = 'float')\n    \n    # TODO ITERATE STATIONS\n    ncIdTmp = nc_create(paste(outdir, paste(paste0(paste(iStat, 'L2', sep = '_'), suffix), 'nc', sep = '.'), sep = '/'), vars = all_vars)\n    \n    #' global attributes\n    ncatt_put(ncIdTmp, 0, 'contact', \"Daniel Neumann\", prec = 'text')\n    ncatt_put(ncIdTmp, 0, 'contact_email', \"daniel.neumann@io-warnemuende.de\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'originator', \"Daniel Neumann\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'contributor_name', \"Hagen Radtke, Thomas Neumann, Fabian Schwichtenberg, Ina Lorkowski\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'institution', \"Leibniz Institute for Baltic Sea Research Warnemuende, Rostock, Germany\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'source', \"model: HBM-ERGOM; grid/domain: fine+coarse; boundary conditions: TODO; initial condition: TODO; hardware: HLRN SMP1 Hannover; compiler set: Intel vTODO; meteo: TODO\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'summary', \"TODO\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'standard_name_vocabulary', \"CF Standard Names 1.6\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'title', \"TODO\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'creationTime', \"2017-05-02T12:00:00Z\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'date_created', \"2017-05-02\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'date_modified', \"2017-05-29\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'crs', \"TODO\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'Conventions', \"CF-1.6\", prec = 'character')\n    ncatt_put(ncIdTmp, 0, 'history', \"\", prec = 'character')\n    \n    abc = 1 + 1;\n    \n    \n    for (iV in varnames$L2) {\n      # print(iV)\n      if(!is.null(varmapping$L1L0[[iV]])) {\n        for (iAtt in intersect(copyAtts,names(dataL2[[varmapping$L1L0[[iV]]]]$attributes))) {\n          ncatt_put(ncIdTmp, varmapping$L2L2[[iV]], iAtt, dataL2[[varmapping$L1L0[[iV]]]]$attributes[[iAtt]], prec = 'character')\n        }\n      }\n      ncatt_put(ncIdTmp, varmapping$L2L2[[iV]], 'coordinates', 'lon lat', prec = 'character')\n      ncvar_put(ncIdTmp, varmapping$L2L2[[iV]], dataL2[[iV]]$data[[iStat]][1,1,,1:all_dims$time$len])\n    }\n    \n    ## time independent depth (averaged)\n    # ncatt_put(ncIdTmp, 'depth2', 'coordinates', 'lon lat', prec = 'character')\n    # ncvar_put(ncIdTmp, 'depth2', rowMeans(dataL2[['depth']]$data[[iStat]], dim = 3))\n    \n    \n    nc_sync(ncIdTmp)\n    \n    ncIdOut[[iStat]] = ncIdTmp\n    \n    nc_close(ncIdTmp)\n  }\n  \n  return(ncIdOut)\n}",
    "created" : 1495557186316.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3620769040",
    "id" : "74BCCBBC",
    "lastKnownWriteTime" : 1497257048,
    "last_content_update" : 1497257048085,
    "path" : "/media/neumannd/work_dell/88_MeRamo/64_validator_data_preparation/workflow/hbm_extract_stations/support/createL2file.R",
    "project_path" : "support/createL2file.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}